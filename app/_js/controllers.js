angular.module('wmProfile.controllers', [])
  .controller('userMeta', ['$scope', '$rootScope', 'badgesService', 'userService', 'loginService',
    function ($scope, $rootScope, badgesService, userService, loginService) {
      // Scope defaults
      $scope.hasFeaturedBadge = false;
      $scope.isEditMode = false;
      $scope.canEdit = false;

      // Extrapolate user information from username
      userService.getUserData($rootScope.WMP.username).then(function (userData) {
        $scope.user = userData.user;
      });

      $scope.$watch('isEditMode', function (newValue, oldValue) {
        // Save when we exit edit mode
        if (newValue === false && oldValue === true) {
          userService.setUserData($rootScope.WMP.username, $scope.user);
        }
      });

      // Show the featured badge if user has it
      badgesService.getBadges($rootScope.WMP.username).then(function (badges) {
        var featuredBadge = 23; // Super mentor

        for (var i = 0, ii = badges.length; i < ii && !$scope.hasFeaturedBadge; i++) {
          if (badges[i].badge.id === featuredBadge) {
            $scope.hasFeaturedBadge = true;
          }
        }
      });

      // Show and hide edit button based on logged in user matching profile owner

      $scope.$on('userLoggedIn', function (event, data) {
        if ($rootScope.WMP.username === data.username) {
          $scope.canEdit = true;
          $scope.$digest();
        }
      });

      $scope.$on('userLoggedOut', function (event, data) {
        $scope.canEdit = false;
        $scope.$digest();
      });
    }
  ])
  .controller('badges', ['$scope', '$rootScope', '$sce', 'badgesService',
    function ($scope, $rootScope, $sce, badgesService) {
      $scope.viewID = 'badges';
      $scope.backpackURL = $sce.trustAsResourceUrl($rootScope.WMP.config.backpackURL);
      $scope.didServiceFail = false;

      badgesService.getBadges($rootScope.WMP.username).then(function success (badges) {
        $scope.badges = badges;
      }, function fail (error) {
        $scope.didServiceFail = true;
      });
    }
  ])
  .controller('teachingResources', ['$scope', '$rootScope', 'makeapi',
    function ($scope, $rootScope, makeapi) {
      $scope.viewID = 'teachingResources';
      $scope.didServiceFail = false;

      makeapi
        .getRemixCounts()
        .user($rootScope.WMP.username)
        .find({
          tags: ['teach']
        })
        .then(function success (err, makes) {
          if (err) {
            console.error(err);
            $scope.didServiceFail = true;
          }

          makes = makeapi.massage(makes);

          $scope.makes = makes;
          $scope.$apply();
        }, function fail (error) {
          $scope.didServiceFail = true;
        });
    }
  ])
  .controller('makes', ['$scope', '$rootScope', 'makeapi',
    function ($scope, $rootScope, makeapi) {
      $scope.viewID = 'makes';
      $scope.didServiceFail = false;
      $scope.currentPage = 0;
      $scope.totalPages = undefined;

      $scope.getPage = function (page) {
        makeapi
          .getRemixCounts()
          .user($rootScope.WMP.username)
          .page(page)
          .then(function success (err, makes, total) {
            if (err) {
              console.error(err);
              $scope.didServiceFail = true;
            }

            $scope.totalPages = Math.ceil(total / 10);

            makes = makeapi.massage(makes);

            $scope.makes = makes;
            $scope.$apply();
          }, function fail (error) {
            $scope.didServiceFail = true;
          });
      }

      $scope.$watch('currentPage', function (newValue, oldValue) {
        $scope.getPage(newValue + 1);
      });
    }
  ])
  .controller('likes', ['$scope', '$rootScope', 'makeapi',
    function ($scope, $rootScope, makeapi) {
      $scope.viewID = 'likes';
      $scope.didServiceFail = false;

      makeapi
        .likedByUser($rootScope.WMP.username)
        .then(function success (err, makes) {
          if (err) {
            console.error(err);
            $scope.didServiceFail = true;
          }

          makes = makeapi.massage(makes);

          $scope.makes = makes;
          $scope.$apply();
        }, function fail (error) {
          $scope.didServiceFail = true;
        });
    }
  ])
  .controller('events', ['$scope', '$rootScope', 'eventService',
    function ($scope, $rootScope, eventService) {
      $scope.viewID = 'events';
      $scope.didServiceFail = false;

      eventService.query({
        username: $rootScope.WMP.username
      }, function success (data) {
        $scope.events = data.sort(function (a, b) {
          return (new Date(b.beginDate).getTime() - new Date(a.beginDate).getTime());
        });
      }, function fail (error) {
        $scope.didServiceFail = true;
      });

      $scope.isDiffYear = function(idx) {
        var curYear = new Date($scope.events[idx].beginDate).getFullYear();

        if (idx === 0) {
          return true;
        }

        var prevYear = new Date($scope.events[idx-1].beginDate).getFullYear();
        return curYear !== prevYear;
      };
    }
  ])
  .controller('createUserController', ['$scope', '$http', '$modal', 'loginService',
    function ($scope, $http, $modal, loginService) {

      loginService.auth.on('newuser', function (assertion) {
        $modal.open({
          templateUrl: '/user/_partials/create-user-form.html',
          controller: createUserCtrl,
          resolve: {
            assertion: function () {
              return assertion;
            }
          }
        });
      });

      var createUserCtrl = function ($scope, $modalInstance, loginService, assertion) {

        $scope.form = {};
        $scope.user = {};

        // TODO: Finish localization and remove hard coded variables.
        $scope.supported_languages = 'en-US';
        $scope.currentLang = 'en-US';
        $scope.langmap = {
          'en-US': {
            'nativeName': 'English (United States)',
            'englishName': 'English (United States)'
          }
        };

        $scope.checkUsername = function () {
          if (!$scope.form.user.username) {
            return;
          }
          $http
            .post(loginService.auth.urls.checkUsername, {
              username: $scope.form.user.username.$viewValue
            })
            .success(function (username) {
              $scope.form.user.username.$setValidity('taken', !username.exists);
            })
            .error(function (err) {
              console.log(err);
              $scope.form.user.username.$setValidity('taken', true);
            });
        };

        $scope.createUser = function () {
          $scope.submit = true;
          if ($scope.form.user.$valid && $scope.form.agree) {
            loginService.auth.createUser({
              assertion: assertion,
              user: $scope.user
            });
            $modalInstance.close();
          }
        };

        $scope.cancel = function () {
          loginService.auth.analytics.webmakerNewUserCancelled();
          $modalInstance.dismiss('cancel');
        };
      };

      loginService.auth.verify();
    }
  ]);
